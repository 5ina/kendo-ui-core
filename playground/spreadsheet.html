<!doctype html>
<html>
    <head>
        <script src="loader.js"></script>
        <meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
        <script>
          requireSync([
            "../src/jquery.js",
            "../src/kendo.dom.js",
            "../src/kendo.spreadsheet.js"
          ]);
        </script>
        <style>
            #wrapper {
                border: 1px solid black;
                width: 800px;
                height: 600px;
                overflow: scroll;
            }

            @media only screen and (max-device-width: 667px) {
                #wrapper {
                    width: 100%;
                    -webkit-overflow-scrolling: touch;
                }

                form {
                    display: none;
                }
            }

            #area {
                height: 10000000px;
                width: 1000000px;
            }

            #container {
                position: fixed;
                overflow: hidden;
            }

            #area table {
                table-layout: fixed;
                position: absolute;
                border-collapse: collapse;
                box-sizing: border-box;
            }

            #container table {
                width: 100%;
                height: 100%;
            }

            #area canvas {
                position:absolute;
            }

            #container canvas {
                width: 100%;
                height: 100%;
            }

            #area table td {
                border: 1px solid gray;
                box-sizing: border-box;
                overflow: hidden;
                font-size: 11px;
                height: 20px;
            }

            .cell {
                box-sizing: border-box;
                border: 1px solid gray;
                overflow: hidden;
                font-size: 11px;
                position: absolute;
            }

            form {
                float: right;
            }
        </style>
    </head>
    <body>
        <form>
            <p>
            <label>FPS:<span id="fps"></span></label>
            </p>
            <p>
            <label>Canvas:<span id="canvas"></span></label>
            </p>
            <p>
            <label>Scroll:<span id="scroll"></span></label>
            </p>
            <p>
            <label>Virtual DOM:<span id="virtual"></span></label>
            </p>
            <p>
            <label>Table:<span id="table"></span></label>
            </p>
            <p>
            <label>innerHTML:<span id="innerHTML"></span></label>
            </p>
            <p>
            <label>translate:<span id="translate"></span></label>
            </p>
            <p>
            <label>translate3d:<span id="translate3d"></span></label>
            </p>
            <p>
            <label>requestAnimationFrame:<span id="raf"></span></label>
            </p>
        </form>
        <button>add cell</button>
        <div id="wrapper">
            <div id="area">
                <div id="container"></div>
            </div>
        </div>

        <script>
            var COLUMNS = 16384;
            var ROWS = 1048576;
            var COLUMN_WIDTH = 64;
            var ROW_HEIGHT = 20;

            var wrapper = document.getElementById("wrapper");
            var container = document.getElementById("container");
            var area = document.getElementById("area");


            var viewportWidth = wrapper.clientWidth;
            var viewportHeight = wrapper.clientHeight;
            container.style.width = viewportWidth + "px";
            container.style.height = viewportHeight + "px";

            var widths = new kendo.spreadsheet.RangeList(0, COLUMNS, COLUMN_WIDTH);
            var heights = new kendo.spreadsheet.RangeList(0, ROWS, ROW_HEIGHT);
            var cellValues = new kendo.spreadsheet.RangeList(0, ROWS * COLUMNS - 1, "");
            var colors = new kendo.spreadsheet.RangeList(0, ROWS * COLUMNS - 1, "beige");

            cellValues.value(1, 200, "Foo");
            colors.value(1, 50, "green");

            widths.value(1, 5, 120);
            widths.value(50, 50, 200);

            heights.value(1, 1, 40);
            heights.value(50, 50, 200);

            var currentHeight = 0;

            var pxHeights = heights.map(function(range) {
                var start = currentHeight;
                currentHeight += (range.end - range.start + 1) * range.value;
                var end = currentHeight - 1;
                return new kendo.spreadsheet.Range(start, end, range);
            });

            var currentWidth = 0;

            var pxWidths = widths.map(function(range) {
                var start = currentWidth;
                currentWidth += (range.end - range.start + 1) * range.value;
                var end = currentWidth - 1;
                return new kendo.spreadsheet.Range(start, end, range);
            });

            function cellValue(index) {
                return cellValues.value(index, index);
            }

            function color(index) {
                return colors.value(index, index);
            }

            //area.style.width = widthSegments[widthSegments.length-1].to + "px";
            //area.style.height = heightSegments[heightSegments.length-1].to + "px";

            var maxWidth = wrapper.scrollWidth - (wrapper.offsetWidth - viewportWidth);
            var maxHeight = wrapper.scrollHeight - (wrapper.offsetHeight - viewportHeight);

            kendo.support.kineticScrollNeeded = true;

            var canvas = false;
            var virtual = true;
            var table = true;
            var innerHTML = !virtual;
            var raf = false;
            var translate = false;
            var translate3d = true;

            if (kendo.support.kineticScrollNeeded) {
                area.removeChild(container);
                area.style.position = "relative";
                container = area;
                //area.style.width = widthSegments[widthSegments.length-1].to + "px";
                //area.style.height = heightSegments[heightSegments.length-1].to + "px";
            }

            document.getElementById("virtual").innerHTML = virtual;
            document.getElementById("table").innerHTML = table;
            document.getElementById("innerHTML").innerHTML = innerHTML;
            document.getElementById("translate").innerHTML = translate;
            document.getElementById("translate3d").innerHTML = translate3d;
            document.getElementById("raf").innerHTML = raf;
            document.getElementById("scroll").innerHTML = kendo.support.kineticScrollNeeded;

            function heightForRowAtIndex(index) {
                return heights.value(index, index);
            }

            function widthForColumnAtIndex(index) {
                return widths.value(index, index);
            }

            var tree = new kendo.dom.Tree(container);

            function visibleRange(list, start, end, max) {
                var startSegment = null;
                var endSegment = null;
                var lastPage = false


                if (end >= max) {
                    lastPage = true;
                }


                var ranges = list.tree.intersecting(new kendo.spreadsheet.Range(start, end));

                startSegment = ranges[0];
                endSegment = ranges[ranges.length - 1];

                var startOffset = start - startSegment.start;

                var startIndex = ((startOffset / startSegment.value.value) >> 0) + startSegment.value.start;

                var offset = startOffset - (startIndex - startSegment.value.start) * startSegment.value.value;

                var endOffset = end - endSegment.start;
                var endIndex = ((endOffset / endSegment.value.value) >> 0) + endSegment.value.start;

                if (endIndex > endSegment.value.end) {
                    endIndex = endSegment.value.end;
                }

                if (lastPage) {
                    offset += endSegment.value.value - (endOffset - (endIndex - endSegment.value.start) * endSegment.value.value);
                }

                return {
                    offset: offset,
                    startIndex: startIndex,
                    endIndex: endIndex
                };
            }

            wrapper.onscroll = scroll;

            var start = new Date();

            var totalHeight = currentHeight - 1;
            var totalWidth = currentWidth - 1;

            function drawTable(left, right, top, bottom) {
                var rows = visibleRange(pxHeights, top, bottom, maxHeight);

                var columns = visibleRange(pxWidths, left, right, maxWidth);

                var x = - columns.offset - 1;
                var y = - rows.offset - 1;

                if (kendo.support.kineticScrollNeeded) {
                    x += left / ((totalWidth - wrapper.clientWidth) / (wrapper.scrollWidth - wrapper.clientWidth));
                    y += top / ((totalHeight - wrapper.clientHeight) / (wrapper.scrollHeight - wrapper.clientHeight));
                }

                if (virtual) {
                    var cols = [];

                    for (var ci = columns.startIndex; ci <= columns.endIndex; ci++) {
                        cols.push(tree.element("col", { style: { width: widthForColumnAtIndex(ci) + "px" } }));
                    }

                    var tr = [];

                    for (var ri = rows.startIndex; ri <= rows.endIndex; ri++) {
                        var height = heightForRowAtIndex(ri);
                        var tds = [];

                        for (var ci = columns.startIndex; ci <= columns.endIndex; ci++) {

                            var text = cellValue(ci * ROWS + ri);
                            var attr = {
                                style: {}
                            };

                            attr.style.backgroundColor = color(ci * ROWS + ri);

                            tds.push(tree.element("td", attr, [ tree.text(text) ] ));
                        }

                        var attr = null;

                        if (height != ROW_HEIGHT) {
                            attr = { style: { height: height + "px" } };
                        }

                        tr.push(tree.element("tr", attr, tds));
                    }

                    var tableAttr = {
                        style: {}
                    };

                    if (translate) {
                        if (kendo.support.touch) {
                            if (translate3d) {
                                tableAttr.style.webkitTransform = "translate3d(" + x + "px," + y + "px,0)";
                            } else {
                                tableAttr.style.webkitTransform = "translate(" + x + "px," + y + "px)";
                            }
                        } else {
                            tableAttr.style.transform = "translate(" + x + "px," + y + "px)";
                        }
                    } else {
                        tableAttr.style.left = x + "px";
                        tableAttr.style.top = y + "px";
                    }

                    tree.render([
                        tree.element("table", tableAttr,
                        [
                            tree.element("colgroup", null, cols),
                            tree.element("tbody", null, tr)
                        ])
                    ]);
                }

                var end = new Date();

                var fps = Math.round(1000/(end-start));
                document.getElementById("fps").innerHTML = fps;

                start = new Date();
            }


            drawTable(0, viewportWidth, 0, viewportHeight);

            var count = 1;

            $("button").click(function() {
                var row = {};
                cells[10] = row;

                for (var i = 0; i < 100; i++) {
                    row[i] = {
                        value: i + "",
                        bold: Math.floor(Math.random() * 1000) % 2 == 0,
                        italic: Math.floor(Math.random() * 1000) % 2 == 0,
                        color: "rgb(" + Math.floor(Math.random() * 255) + "," + Math.floor(Math.random() * 255) + "," +Math.floor(Math.random() * 255) + ")"
                    };
                }
                scroll();
            });

            function scroll() {
                var top = Math.floor(wrapper.scrollTop * ((totalHeight - wrapper.clientHeight) / (wrapper.scrollHeight - wrapper.clientHeight)));
                var bottom = top + viewportHeight;

                if (top < 0) {
                    bottom -= top;
                    top = 0;
                }

                var left = Math.floor(wrapper.scrollLeft * ((totalWidth - wrapper.clientWidth) / (wrapper.scrollWidth - wrapper.clientWidth)));
                var right = left + viewportWidth;

                if (left < 0) {
                    right -= left;
                    left = 0;
                }

                if (raf) {
                    requestAnimationFrame(function() {
                        drawTable(left, right, top, bottom);
                    });
                } else {
                    drawTable(left, right, top, bottom);
                }
            }
        </script>
    </body>
</html>
