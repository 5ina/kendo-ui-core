<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8"/>
    <title>Editing</title>
<link href="http://cdn.kendostatic.com/2014.3.1316/styles/kendo.common.min.css" rel="stylesheet" /><link href="http://cdn.kendostatic.com/2014.3.1316/styles/kendo.rtl.min.css" rel="stylesheet" /><link href="http://cdn.kendostatic.com/2014.3.1316/styles/kendo.default.min.css" rel="stylesheet" /><link href="http://cdn.kendostatic.com/2014.3.1316/styles/kendo.default.mobile.min.css" rel="stylesheet" /><link href="http://cdn.kendostatic.com/2014.3.1316/styles/kendo.dataviz.min.css" rel="stylesheet" /><link href="http://cdn.kendostatic.com/2014.3.1316/styles/kendo.dataviz.default.min.css" rel="stylesheet" />
    
    <script src="../../src/jquery.js"></script>
    <script src="../../src/kendo.core.js"></script>    
    <script src="../../src/kendo.userevents.js"></script>
    <script src="../../src/kendo.color.js"></script>
    <script src="../../src/kendo.data.js"></script>
    <script src="../../src/kendo.binder.js"></script>
    <script src="../../src/kendo.popup.js"></script>
    <script src="../../src/kendo.list.js"></script>
    <script src="../../src/kendo.draganddrop.js"></script>
    <script src="../../src/kendo.slider.js"></script>
    <script src="../../src/kendo.resizable.js"></script>    
    <script src="../../src/kendo.fx.js"></script>
    <script src="../../src/kendo.mobile.scroller.js"></script>
    <script src="../../src/kendo.toolbar.js"></script>
    <script src="../../src/kendo.window.js"></script>
    <script src="../../src/kendo.validator.js"></script>
    <script src="../../src/kendo.editable.js"></script>
    <script src="../../src/kendo.numerictextbox.js"></script>
    <script src="../../src/kendo.dropdownlist.js"></script>


     <script src="../../src/util/main.js"></script>     
     <script src="../../src/mixins/observers.js"></script>
     <script src="../../src/geometry/main.js"></script>
     <script src="../../src/drawing/core.js"></script>     
     <script src="../../src/drawing/mixins.js"></script>
     <script src="../../src/drawing/text-metrics.js"></script>
     <script src="../../src/drawing/shapes.js"></script>
     <script src="../../src/drawing/parser.js"></script>
     <script src="../../src/drawing/svg.js"></script>
     <script src="../../src/drawing/canvas.js"></script>
     <script src="../../src/drawing/vml.js"></script>
     
    <script src="../../src/kendo.dataviz.core.js"></script>
    <script src="../../src/kendo.dataviz.themes.js"></script>     

    <script src="../../src/dataviz/diagram/utils.js" type="text/javascript"></script>
    <script src="../../src/dataviz/diagram/math.js" type="text/javascript"></script>
    <script src="../../src/dataviz/diagram/svg.js" type="text/javascript"></script>
    <script src="../../src/dataviz/diagram/services.js" type="text/javascript"></script>
    <script src="../../src/dataviz/diagram/dom.js" type="text/javascript"></script>
    <script src="../../src/dataviz/diagram/layout.js" type="text/javascript"></script>
</head>
<body>
<button type="button" id="updateConnectors">Update Connectors</button>
<div id="diagram" ></div>
<div id="plain" ></div>
<div id="hierarchical" ></div>

<script>

function operation(type, options, key, data) {
    setTimeout(function() {
        if (success) {
            var arr = $.parseJSON(localStorage[key]), idx;
            if (type === "read") {            
                options.success(arr);
            } else if (type == "create") {
                arr.push(data);
                options.success(data);                
            } else if (type == "update") {
                idx = findIdx(arr, data.id);
                kendo.deepExtend(arr[idx], data);
                options.success();
            } else if (type == "destroy") {
                idx = findIdx(arr, data.id);
                arr.splice(idx, 1);
                options.success();                
            }
            localStorage[key] = kendo.stringify(arr);
        } else {
            options.error();
        }
    }, 100);
}
function findIdx(data, id) {
    for (var idx = 0; idx < data.length; idx++) {
        if (data[idx].id === id) {
            return idx;
        }
    }
    return -1;
}

    var shapes, connections;
    
    function reset() {
     var shapes = [{id: 1, text: "test1", type: "circle", x: 100, y: 100, width: 100, height: 100},
                            {id: 2, text: "test2", type: "rectangle", x: 300, y: 100, width: 100, height: 100},
                            {id: 3, text: "test3", type: "rectangle", x: 400, y: 400, width: 100, height: 100}];
        localStorage["shapes"] = kendo.stringify(shapes);
         var connections = [{id: 1, from: 1, to: 2}];
        localStorage["connections"] = kendo.stringify(connections);
    }
      
        var shapeId = $.parseJSON(localStorage["shapes"]).length + 1;
        var connectionId = $.parseJSON(localStorage["connections"]).length + 1;
        var success = true;
        var shapesDataSource = {
                batch: false,
                transport: {
                    read: function(options) {
                        operation("read", options, "shapes");
                    },
                    update: function(options) {
                        console.log("update", options.data);
                        operation("update", options, "shapes", options.data);
                    },
                    destroy: function(options) {
                        console.log("destroy shape", options.data);
                        operation("destroy", options, "shapes", options.data);
                    },
                    create: function(options) {
                        console.log("create", options.data);
                        options.data.id = shapeId++;
                        operation("create", options, "shapes", options.data);
                    }
                },
                schema: {
                    model: {
                        id: "id",
                        fields: {
                              id: {type: "number", editable: false },     
                              text: { type: "string", defaultValue: "kor"},
                              type: { type: "string", defaultValue: "rectangle"},
                              x: {type: "number", defaultValue: 100},
                              y: {type: "number", defaultValue: 100},
                              width: { type: "number", defaultValue: 100},
                              height: { type: "number", defaultValue: 100}
                        }
                    }
                }
            };

            var connectionsDataSource = {
                batch: false,
                transport: {
                    read: function(options) {
                        operation("read", options, "connections");
                    },
                    update: function(options) {
                        console.log("update conn", options.data);
                        operation("update", options, "connections", options.data);
                    },
                    destroy: function(options) {
                        console.log("destroy conn");
                        operation("destroy", options, "connections", options.data);
                    },
                    create: function(options) {
                        console.log("create conn", options.data);
                        options.data.id = connectionId++;
                        operation("create", options, "connections", options.data);
                    }
                },
                schema: {
                    model: {
                        id: "id",
                        fields: {
                            id: {type: "number", editable: false },
                            from: { type: "number" },
                            to: { type: "number" },
                            fromX: { type: "number" },
                            fromY: { type: "number" },
                            toX: { type: "number" },
                            toY: { type: "number" }
                        }
                    }
                }
            };

            var diagram = $("#diagram").kendoDiagram({
                dataSource: shapesDataSource,
                connectionsDataSource: connectionsDataSource,
                shapeDefaults: {
                    content: {
                        template: "#:text#"
                    }
                },
    add: function(e) {
       console.log("add", e);
       if (e.shape) {
        e.preventDefault();
        //e.connection.type("cascading");                    
       }
       // e.connection.type("polyline");                    
    },
    remove: function(e) {
       console.log("remove", e);
    }
    }).data("kendoDiagram");
    
    function updateConnectors() {
        var shape = diagram.shapes[0];

        shape.redraw({
          connectors: [{ name: "top" }]
        });
        diagram.connectionsDataSource.sync();
    }

            $("#updateConnectors").click(updateConnectors);
</script>
</body>
</html>
