<!doctype html>
<html>
    <head>
        <script src="../loader.js"></script>
        <meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">

        <link rel="stylesheet" href="../../dist/styles/web/kendo.common.css">
        <link rel="stylesheet" href="../../dist/styles/web/kendo.flat.css">

        <script src="./jszip.js"></script>

        <script>
            requireSync([
                "../../src/jquery.js",
                "../../src/kendo.ooxml.js",
                "../../src/kendo.spreadsheet.js"
            ]);
        </script>
    </head>
    <body>
        <form>
            <input id="file" type="file" />
        </form>
        <div id="spreadsheet" style="width: 1200px;"></div>
        <script>
            $("#spreadsheet").kendoSpreadsheet({
                rows: 1000,
                columns: 1000
            });

            $("#file").on("change", function(e) {
                var file = e.target.files[0];
                e.target.parentNode.reset();

                var spreadsheet = $("#spreadsheet").data("kendoSpreadsheet");
                spreadsheet.fromJSON({ sheets: [] });
                kendo.ooxml.importFile(file, {
                    sheet: function(sheet) {
                        var worksheet;
                        if (sheet.index === 0) {
                            worksheet = spreadsheet.sheetByIndex(0);
                        } else {
                            worksheet = spreadsheet.insertSheet();
                            spreadsheet.sheetByIndex(sheet.index - 1)
                            .suspendChanges(false)
                            .triggerChange();
                        }

                        sheet.owner = worksheet;
                        worksheet.name(sheet.name);
                        worksheet.suspendChanges(true);
                    },
                    row: function(row, sheet) {
                        row.owner = sheet.owner;
                    },
                    cell: function(cell, row) {
                        var range = row.owner.range(row.index, cell.index);
                        range.value(cell.value);
                        //range.formula(cell.formula);
                    }
                });
            });



            kendo.ooxml.importFile = function(file, visitors) {
                var reader = new FileReader();

                reader.onload = function(e) {
                    var zip = new JSZip(e.target.result);
                    readWorkbook(zip, visitors);
                };

                reader.readAsArrayBuffer(file);
            }

            function readWorkbook(zip, visitors) {
                var sheets = [];
                var workbook = {
                    sheets: sheets
                };

                console.time("read");
                var doc = parseFile(zip, "xl/workbook.xml");
                var sheetList = doc.querySelectorAll("sheet");

                var strings = readStrings(zip);

                for (var i = 0; i < sheetList.length; i++) {
                    var sheetElement = sheetList[i];
                    var id = parseInt(sheetElement.getAttribute("r:id").replace("rId", ""), 10);
                    //var id = parseInt(sheetElement.getAttribute("sheetId"), 10);
                    var data = parseFile(zip, "xl/worksheets/sheet" + id + ".xml");
                    var name = sheetElement.getAttribute("name");

                    var sheet = {
                        name: name,
                        index: i
                    };

                    visitors.sheet(sheet, workbook);
                    readSheet(data, strings, sheet, visitors);
                    sheets.push(sheet);
                }
                console.timeEnd("read");

                return workbook;
            }

            function readStrings(zip) {
                var shared = parseFile(zip, "xl/sharedStrings.xml");
                var texts = shared.querySelectorAll("t");

                var strings = [];
                for (var i = 0; i < texts.length; i++) {
                    strings.push(texts[i].innerHTML);
                }

                return strings;
            }

            function readSheet(data, strings, sheet, visitors) {
                var rowList = data.querySelectorAll("sheetData row");
                for (var i = 0; i < rowList.length; i++) {
                    readRow(rowList[i], strings, sheet, visitors)
                }
            }

            function readRow(element, strings, sheet, visitors) {
                var row = {
                    index: parseInt(element.getAttribute("r"), 10) - 1
                };
                visitors.row(row, sheet);

                var cellList = element.children || element.childNodes;
                for (var i = 0; i < cellList.length; i++) {
                    var cell = readCell(cellList[i], strings);
                    visitors.cell(cell, row);
                }

                return row;
            }

            var colRegEx = /[a-z]*/i;
            function readCell(element, strings) {
                var ref = element.getAttribute("r").match(colRegEx)[0];
                var cell = {
                    index: getcol(ref)
                };

                var type = element.getAttribute("t");
                var children = element.children || element.childNodes;

                for (var i = 0; i < children.length; i++) {
                    var child = children[i];
                    var content = child.innerHTML;

                    if (child.nodeName === "v") {
                        value = content;
                        if (type === "n") {
                            value = parseFloat(value);
                        } else if (type === "b") {
                            value = new Boolean(value);
                        } else if (type === "s") {
                            value = strings[parseInt(value, 10)];
                        }

                        cell.value = value;
                    } else if (child.nodeName === "f" && content !== "") {
                        cell.formula = content;
                    }
                }

                return cell;
            }

            function parseFile(zip, file) {
                return parseXML(zip.files[file].asText());
            }

            // Copied from calc.js to avoid introducing dependency
            function getcol(str) {
                str = str.toUpperCase();
                for (var col = 0, i = 0; i < str.length; ++i) {
                    col = col * 26 + str.charCodeAt(i) - 64;
                }
                return col - 1;
            }

            var parseXML;
            if (typeof DOMParser != "undefined") {
                parseXML = function(str) {
                    var parser = new DOMParser();
                    var dom = parser.parseFromString(str, "text/xml");
                    if (dom.documentElement.nodeName == "parsererror") {
                        throw new Error("Error while parsing XML: " + dom.documentElement.innerHTML);
                    }

                    return dom;
                };
            } else {
                parseXML = function(str) {
                    var doc = new ActiveXObject("Microsoft.XMLDOM");
                    doc.async = "false";
                    doc.loadXML(str);

                    return doc;
                }
            }
        </script>
    </body>
</html>
