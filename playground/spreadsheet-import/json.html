<!doctype html>
<html>
    <head>
        <script src="../loader.js"></script>
        <meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">

        <link rel="stylesheet" href="../../dist/styles/web/kendo.common.css">
        <link rel="stylesheet" href="../../dist/styles/web/kendo.flat.css">

        <script src="./jszip.js"></script>

        <script>
            requireSync([
                "../../src/jquery.js",
                "../../src/kendo.ooxml.js",
                "../../src/kendo.spreadsheet.js"
            ]);
        </script>
    </head>
    <body>
        <input id="file" type="file" />
        <div id="spreadsheet" style="width: 1200px;"></div>
        <script>
            $("#spreadsheet").kendoSpreadsheet({
                rows: 2000,
                columns: 1000
            });

            $("#file").on("change", function(e) {
                var file = e.target.files[0];

                console.time("read");
                kendo.ooxml.importFile(file)
                .done(function(workbook) {
                    var spreadsheet = $("#spreadsheet").data("kendoSpreadsheet");
                    spreadsheet.fromJSON(workbook);
                    console.timeEnd("read");
                });
            });



            kendo.ooxml.importFile = function(file) {
                var deferred = new $.Deferred();
                var reader = new FileReader();

                reader.onload = function(e) {
                    //try {
                        //deferred.progress({
                        //    operation: "Reading",
                        //    progress: 0
                        //});

                        var zip = new JSZip(e.target.result);

                        //deferred.progress({
                        //    operation: "Reading",
                        //    progress: 1
                        //});

                        var workbook = readWorkbook(zip);
                        deferred.resolve(workbook);
                    //} catch(e) {
                    //  deferred.reject("Error reading " + file.name + " : " + e.message, e);
                    //}
                };

                reader.readAsArrayBuffer(file);

                return deferred;
            }

            function readWorkbook(zip) {
                var sheets = [];
                var workbook = {
                    sheets: sheets
                };

                var doc = parseFile(zip, "xl/workbook.xml");
                var sheetList = doc.querySelectorAll("sheet");

                var strings = readStrings(zip);

                for (var i = 0; i < sheetList.length; i++) {
                    var sheetElement = sheetList[i];
                    var id = parseInt(sheetElement.getAttribute("r:id").replace("rId", ""), 10);
                    var data = parseFile(zip, "xl/worksheets/sheet" + id + ".xml");
                    var name = sheetElement.getAttribute("name");

                    sheets.push({
                        name: name,
                        rows: readSheet(data, strings)
                    });
                }

                return workbook;
            }

            function readStrings(zip) {
                var shared = parseFile(zip, "xl/sharedStrings.xml");
                var texts = shared.querySelectorAll("t");

                var strings = [];
                for (var i = 0; i < texts.length; i++) {
                    strings.push(texts[i].innerHTML);
                }

                return strings;
            }

            function readSheet(data, strings) {
                var rows = [];
                var rowList = data.querySelectorAll("sheetData row");
                for (var i = 0; i < rowList.length; i++) {
                    rows.push(
                        readRow(rowList[i], strings)
                    );
                }

                return rows;
            }

            function readRow(element, strings) {
                var cells = [];
                var row = {
                    index: parseInt(element.getAttribute("r"), 10) - 1,
                    cells: cells
                };

                var cellList = element.children || element.childNodes;
                for (var i = 0; i < cellList.length; i++) {
                    cells.push(
                        readCell(cellList[i], strings)
                    );
                }

                return row;
            }

            var colRegEx = /[a-z]*/i;
            function readCell(element, strings) {
                var ref = element.getAttribute("r").match(colRegEx)[0];
                var cell = {
                    index: getcol(ref)
                };

                var type = element.getAttribute("t");
                var children = element.children || element.childNodes;

                for (var i = 0; i < children.length; i++) {
                    var child = children[i];
                    var content = child.innerHTML;

                    if (child.nodeName === "v") {
                        value = content;
                        if (type === "n") {
                            value = parseFloat(value);
                        } else if (type === "b") {
                            value = new Boolean(value);
                        } else if (type === "s") {
                            value = strings[parseInt(value, 10)];
                        }

                        cell.value = value;
                    } else if (child.nodeName === "f" && content !== "") {
                        //cell.formula = content;
                    }
                }

                return cell;
            }

            function parseFile(zip, file) {
                return parseXML(zip.files[file].asText());
            }

            // Copied from calc.js to avoid introducing dependency
            function getcol(str) {
                str = str.toUpperCase();
                for (var col = 0, i = 0; i < str.length; ++i) {
                    col = col * 26 + str.charCodeAt(i) - 64;
                }
                return col - 1;
            }

            var parseXML;
            if (typeof DOMParser != "undefined") {
                parseXML = function(str) {
                    var parser = new DOMParser();
                    var dom = parser.parseFromString(str, "text/xml");
                    if (dom.documentElement.nodeName == "parsererror") {
                        throw new Error("Error while parsing XML: " + dom.documentElement.innerHTML);
                    }

                    return dom;
                };
            } else {
                parseXML = function(str) {
                    var doc = new ActiveXObject("Microsoft.XMLDOM");
                    doc.async = "false";
                    doc.loadXML(str);

                    return doc;
                }
            }
        </script>
    </body>
</html>
