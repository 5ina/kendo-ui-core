﻿<#@ template language="C#" HostSpecific="True" #>
<#@ output extension=".cshtml" #>
<#@ include file="..\ImportsChartView.include.t4" #>
<#
    var entitySetName = ModelMetadata.EntitySetName;
#>
<div id="chart"></div>
<script>
    $("#chart").kendoChart({
        title: "<#= ChartTitle #>",
<#
if(LegendVisible) {
#>
        legend: {
            position: "<#= LegendPosition #>"
        },
<#
}
if(TooltipVisible) {
#>
        tooltip: {
            visible: true
        },
<#
}
#>
        dataSource: {
            transport: {
                read: {
                    url: "<#= entitySetName #>_Read"
                }
            }
        },
        <#RenderSeries(SeriesType, SeriesConfigs, SeriesNames, SeriesColors);#><#if(CategoryAxis != null && CategoryAxis != string.Empty){#>,
        categoryAxis: {
            field : "<#= CategoryAxis #>"
        }
<#
}
#>
})
</script>

<#+
    private string Tabs(int count)
    {
        return String.Concat(Enumerable.Repeat("\t", count));
    }

    private string InitializeChart(string type)
    {
        var newLine = Environment.NewLine;
        var seriesType = Char.ToLowerInvariant(type[0]) + type.Substring(1);
        var align = newLine + Tabs(2);

        return "seriesDefaults: {" + newLine + Tabs(3) + "type: \"" + seriesType + "\"" + align + "}," + align + "series: [";
    }

    private string NormalizeColorAndNames(string SeriesNames, string SeriesColors)
    {
        string result = "";
        string newLine= Environment.NewLine;

        result += SeriesNames != string.Empty ? ", " + newLine + Tabs(4) +"name: \"" + SeriesNames +"\"" : "";
        result +=SeriesColors != string.Empty ? ", " + newLine + Tabs(4) +"color: \"" + SeriesColors +"\"" + newLine + Tabs(3) + "}" : "";

        return result;
    }

    private void RenderSeries(string seriesType, List<List<string>> SeriesConfigs, List<string> SeriesNames, List<string> SeriesColors) 
    {
        List<string> commonCharts = new List<string> {"Area", "Bar", "Column", "Donut", "Funnel", "HorizontalWaterfall", "Line", 
                                                     "Pie", "RadarArea", "RadarColumn", "RadarLine", "VerticalArea", "VerticalLine", "Waterfall"};
        if (commonCharts.Contains(seriesType)) 
        {   
            RenderCommonCharts(seriesType, SeriesConfigs, SeriesNames, SeriesColors);
        } 
        else if (seriesType == "RangeBar" || seriesType == "RangeColumn" )
        {
            RenderRangeCharts(seriesType, SeriesConfigs, SeriesNames, SeriesColors);
        } 
        else if (seriesType == "PolarArea" || seriesType == "PolarLine" || seriesType == "PolarScatter")
        {
            RenderPolarCharts(seriesType, SeriesConfigs, SeriesNames, SeriesColors);
        }
    }
#>
<#+

    private void RenderCommonCharts(string seriesType, List<List<string>> SeriesConfigs, List<string> SeriesNames, List<string> SeriesColors) 
    {
        var newLine = Environment.NewLine;
        string result = InitializeChart(seriesType);

        for (int i = 0; i < SeriesNames.Count; i++) 
        {
            for (int j = 0; j < SeriesConfigs[i].Count; j++) 
            {
                bool isLast = SeriesConfigs[i].Equals(SeriesConfigs[SeriesConfigs.Count - 1]);

                result += newLine + Tabs(3) + "{" + newLine + Tabs(4) + "field: \""+ SeriesConfigs[i][j] +"\"";
                result += NormalizeColorAndNames(SeriesNames[i], SeriesColors[i]);
                result +=  isLast ? newLine : ",";
            }
        }
        result += Tabs(2) + "],";

#>
<#=result#>
<#+
    }
#>

<#+
    private void RenderRangeCharts(string seriesType, List<List<string>> SeriesConfigs, List<string> SeriesNames, List<string> SeriesColors) 
    {
        var newLine = Environment.NewLine;
        string result = InitializeChart(seriesType);

        for (int i = 0; i < SeriesNames.Count; i++) 
        {
            for (int j = 0; j < SeriesConfigs[i].Count; j+=2) 
            {
                bool isLast = SeriesConfigs[i].Equals(SeriesConfigs[SeriesConfigs.Count - 1]);

                result += newLine + Tabs(3) + "{" + newLine + Tabs(4) + "fromField: \""+ SeriesConfigs[i][j] +"\",";
                result += newLine + Tabs(4) + "toField: \""+ SeriesConfigs[i][j+1] +"\"";
                result += SeriesNames[i] != string.Empty ? ", " + newLine + Tabs(4) +"name: \"" + SeriesNames[i] +"\"" : "";
                result += SeriesColors[i] != string.Empty ? ", " + newLine + Tabs(4) +"color: \"" + SeriesColors[i] +"\"" + newLine + Tabs(3) + "}" : "";
                result +=  isLast ? newLine : ",";
            }
        }
        result += Tabs(2) + "]";

#>
<#=result#>
<#+
    }
#>

<#+
    private void RenderPolarCharts(string seriesType, List<List<string>> SeriesConfigs, List<string> SeriesNames, List<string> SeriesColors) 
    {
        var newLine = Environment.NewLine;
        string result = InitializeChart(seriesType);

        for (int i = 0; i < SeriesNames.Count; i++) 
        {
            for (int j = 0; j < SeriesConfigs[i].Count; j+=2) 
            {
                var isLast = SeriesConfigs[i].Equals(SeriesConfigs[i].Last());

                result += newLine + Tabs(3) + "{" + newLine + Tabs(4) + "fromField: \""+ SeriesConfigs[i][j] +"\",";
                result += newLine + Tabs(4) + "toField: \""+ SeriesConfigs[i][j+1] +"\"";
                result += SeriesNames[i] != string.Empty ? ", " + newLine + Tabs(4) +"name: \"" + SeriesNames[i] +"\"" : "";
                result += SeriesColors[i] != string.Empty ? ", " + newLine + Tabs(4) +"color: \"" + SeriesColors[i] +"\"" : "";
                result += newLine + Tabs(3) + "}," + newLine;
            }
        }
        result += Tabs(2) + "]";

#>
<#=result#>
<#+
    }
#>
