#!/bin/sh

# Script should not be called directly, use rake bower:push

bowergit="git --work-tree=$2 --git-dir=$2/.git"

if [ ! -d $2 ]; then
    git clone $1 $2
else
    $bowergit fetch
    $bowergit reset --hard origin/master
    $bowergit clean -dfx
fi;

# src is removed for historical reasons
for dir in `find $3 -type d  -mindepth 1 -maxdepth 1`
do
    rsync -av --delete $dir/ $2/${dir##*/}/
done

# OS X sed is quite peculiar - use gnu sed if present
if which gsed; then
   sed_bin="gsed"
else
   sed_bin="sed"
fi

$sed_bin -i "s/\"[[:digit:]]\+\.[[:digit:]]\+\.[[:digit:]]\+\"/\"$VERSION\"/" $2/bower.json

$bowergit add --all .
$bowergit commit -m "Update to $VERSION"
$bowergit tag -a "$TAG" -m "$VERSION"
$bowergit push origin master
$bowergit push origin "$TAG"
