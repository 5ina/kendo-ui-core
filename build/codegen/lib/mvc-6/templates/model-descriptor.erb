namespace Kendo.Mvc.UI
{
    using Extensions;
    using System;
    using System.Collections.Generic;
    using Microsoft.AspNet.Mvc.ModelBinding;
    using System.Reflection;

    public class <%= type %>ModelDescriptor : ModelDescriptor
    {
        public <%= type %>ModelDescriptor(Type modelType, IModelMetadataProvider modelMetadataProvider)
            : base(modelType, modelMetadataProvider)
        {
        }

% members.select{ |o| !o.interface.nil? }.each do |member|
        public string <%= member.name.pascalize %> { get; set; }
% end

        protected override void Serialize(IDictionary<string, object> json)
        {
            if (Id != null)
            {
                json["id"] = Id.Name;
            }

            var fields = new Dictionary<string, object>();
            json["fields"] = fields;

            Fields.Each(prop =>
            {
                var field = new Dictionary<string, object>();

                var modelInterface = typeof (I<%= type %>);

                var currentMember = prop.Member;

% members.select{ |o| !o.interface.nil? }.each_with_index do |member, index|
                <%unless index == 0 %>else <%end%>if (<%= member.name.pascalize %>.HasValue() && currentMember == <%= member.name.pascalize %>)
                {
                    fields["<%= member.name %>"] = field;
                    field["from"] = currentMember;
                }
% end
                else if (modelInterface.GetProperty(currentMember) != null)
                {
                    var updatedMember = Char.ToLowerInvariant(currentMember[0]) + currentMember.Substring(1);
                    fields[updatedMember] = field;
                    field["from"] = currentMember;
                }
                else
                {
                    fields[currentMember] = field;
                }

                if (!prop.IsEditable)
                {
                    field["editable"] = false;
                }

                field["type"] = prop.MemberType.ToJavaScriptType().ToLowerInvariant();

                if (prop.MemberType.IsNullableType() || prop.DefaultValue != null)
                {
                    field["defaultValue"] = prop.DefaultValue;
                }
            });
        }
    }
}
