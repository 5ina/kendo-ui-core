#!/bin/sh

# Script should not be called directly, use rake bower:push

REPO_URL=$1
WORKING_DIR=$2
BUNDLE_DIR=$3

bowergit="git --work-tree=$WORKING_DIR --git-dir=$WORKING_DIR/.git"

if [ ! -d $WORKING_DIR ]; then
    git clone $REPO_URL $WORKING_DIR
else
    $bowergit fetch
    $bowergit reset --hard origin/master
    $bowergit clean -dfx
fi;

rm -rf $WORKING_DIR/{js,styles,src}
cp -rf $BUNDLE_DIR/js $WORKING_DIR
cp -rf $BUNDLE_DIR/src $WORKING_DIR
rsync -av $BUNDLE_DIR-source/src --exclude 'AspNet*' --exclude 'Kendo*' --exclude 'Telerik*' --exclude 'README' $WORKING_DIR
cp -rf $BUNDLE_DIR/styles $WORKING_DIR

cd $WORKING_DIR
sed "s/\"version\".*/\"version\": \"$VERSION\",/" bower.json > bower.json.new && mv bower.json.new bower.json

$bowergit add --all .
$bowergit commit -m "Update to $VERSION"
$bowergit tag -a "$VERSION" -m "$VERSION"
$bowergit push origin master
$bowergit push origin "$VERSION"
